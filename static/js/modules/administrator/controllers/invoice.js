Controller.define("administrator/invoice",function(){return{model:{deleteInvoice:function(a){return $.ajax({type:"post",url:Registry.get("SITE_URL")+"admin/invoice/delete",data:a,dataType:"json"})},loadWarehouse:function(a){return $.ajax({type:"GET",url:Registry.get("SITE_URL")+"admin/invoice/load-warehouse",data:a,dataType:"json"})},formatNumber:function(a){x=(a+"").split(".");x1=x[0];x2=1<x.length?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2},loadCustomer:function(a){return $.ajax({type:"GET",
url:Registry.get("SITE_URL")+"admin/invoice/load-customer",data:a,dataType:"json"})},addCustomer:function(a){return $.ajax({type:"POST",url:Registry.get("SITE_URL")+"admin/customer/add-customer",data:a,dataType:"json"})}},actions:{index:{require:{scripts:["bootbox/bootbox.js"],stylesheets:[]},execute:function(){var a=this,b=function(){if(0>=a.find("input[name=data-id]:checked").length)return bootbox.alert("Vui l\u00f2ng ch\u1ecdn s\u1ea3n ph\u1ea9m mu\u1ed1n x\u00f3a!!!"),!1;bootbox.confirm("B\u1ea1n c\u00f3 ch\u1eafc ch\u1eafn mu\u1ed1n x\u00f3a c\u00e1c s\u1ea3n ph\u1ea9m n\u00e0y kh\u00f4ng???",
function(b){if(b){var f=[];a.find("input[name=data-id]:checked").each(function(){f.push($(this).val())});a.model.deleteProduct({arr_product_id:f}).then(function(a){1==a.st?bootbox.alert(a.ms,function(){window.location=window.location.href}):bootbox.alert(a.ms)})}})};a.on("click",".remove-all",function(){b()})}},create:{require:{scripts:["bootstrap-select.js","bootstrap-inputmask.js","bootbox/bootbox.js"],stylesheets:["bootstrap-select.css"]},execute:function(){var a=this,b={},j=Registry.get("WAREHOUSES"),
f=function(){a.find(".select-picker").selectpicker({});a.find(".price-mask").inputmask({alias:"decimal",radixPoint:".",groupSeparator:",",autoGroup:!0,rightAlign:!0,autoUnmask:!0,removeMaskOnSubmit:!0,digits:0});a.find('[data-toggle="tooltip"]').tooltip()},i=function(){var d=0;0<a.find(".total_price").length&&$.each(a.find(".total_price"),function(){d+=+$(this).val()});a.find(".sum_total_price").text(a.model.formatNumber(d));a.find("input[name=sum_total_price]").val(d)},m=function(){0<a.find("tbody tr").length&&
$.each(a.find("tbody tr"),function(a,c){$(c).find(".stt").text(a+1)})},k=function(){var d=[];0<a.find("select.warehouse_id").length&&a.find("select.warehouse_id").each(function(){d.push(+$(this).val())});var c='<select name="warehouse_id[]" class="form-control warehouse_id select-picker" data-live-search="true">',g="",h=0,n=!1,f=0;$.each(j.rows,function(a,b){if(-1==$.inArray(b.warehouse_id,d)){var l=b.product_name+" - S\u1ed1 L\u00f4 :"+b.production_batch+" - H\u00e3ng : "+b.brand_name+" - HSD : "+
b.hsd+" - T\u1ed3n :"+b.stock;c+='<option value="'+b.warehouse_id+'" data-price="'+b.unit_price+'" data-properties="'+b.properties_name+'">';c+=l;c+="</option>";!1==n&&(g=b.properties_name,h=+b.unit_price,f=b.warehouse_id);n=!0}});var l=a.find("table tbody tr").length+1,c=c+"</select>";a.find("tbody").append("<tr>"+('<td class="text-center stt">'+l+"</td>")+('<td class="text-center">'+c+"</td>")+('<td class="text-center">'+g+"</td>")+'<td class="text-right"><input class="form-control input price-mask quantity" name="quantity[]"><span class="error error-no-choose-quantity red" style="display: none">Nh\u1eadp SL</span></td>'+
('<td class="text-right"><input class="form-control input price-mask unit_price" name="price[]" readonly value="'+h+'"></td>')+'<td class="text-right"><input class="form-control input price-mask discount" name="discount[]"></td><td class="text-right"><input class="form-control input price-mask total_price" name="total_price[]" readonly value="0"></td><td class="text-center"><div class="hidden-sm hidden-xs btn-group"><a class="btn btn-xs btn-primary edit" data-toggle="tooltip"  style="display: none" title="S\u1eeda"><i class="ace-icon fa fa-pencil bigger-120"></i></a><a class="btn btn-xs btn-success save" data-toggle="tooltip" style="display: none" title="X\u00e1c nh\u1eadn"><i class="ace-icon fa fa-check bigger-120"></i></a><a class="btn btn-xs btn-danger remove-item" title="X\u00f3a"><i class="ace-icon fa fa-trash bigger-120"></i></a></td>');
b={};e(l,f)},h=function(){var d=[],b=a.find("#tags").val();a.model.loadCustomer({search:b}).then(function(a){if(-1==a.st)return d;$.each(a.data.rows,function(a,b){var c=b.full_name,g=b.full_name;b.phone&&(g+=" - ".v.phone);b.phone&&(g+=" - ".v.address);d.push({value:c,label:g,customer_id:b.customer_id,phone:b.phone,address:b.address,note:b.note,full_name:b.full_name})})});return d},e=function(d,c){$.each(a.find("select.warehouse_id"),function(a){0!=d&&a==d-1||($(this).find("option[value="+c+"]").remove(),
$.isEmptyObject(b)||(a="<option value="+b.warehouse_id+" data-price="+b.price+" data-properties="+b.properties_name+">",a+=b.name_show,$(this).append(a+"</option>")))});b={};a.find(".select-picker").selectpicker("destroy");a.find(".select-picker").selectpicker();f()};a.on("click",".add-product",k).on("click",".edit",function(){}).on("keyup",".quantity, .discount",function(){var a=+$(this).closest("tr").find(".quantity").val(),b=+$(this).closest("tr").find(".unit_price").val(),g=+$(this).closest("tr").find(".discount").val();
$(this).closest("tr").find(".total_price").val(b*a-b*a*g/100);i()}).on("click",".remove-item",function(){var a=$(this).closest("tr").find("option:selected");b.price=$(a).data("price");b.warehouse_id=$(a).val();b.properties_name=$(a).data("properties");b.name_show=$(a).text();$(this).closest("tr").remove();m();e(0,0);i()}).on("change","select.warehouse_id",function(){var a=+$(this).closest("tr").find(".stt").text(),b=$(this).val(),g=+$(this).closest("tr").find(".quantity").val(),h=+$(this).find("option:selected").data("price"),
f=+$(this).closest("tr").find(".discount").val(),g=h*g-h*g*f/100;$(this).closest("tr").find(".unit_price").val(h);$(this).closest("tr").find(".total_price").val(g);i();e(a,b)}).on("click",".add-customer",function(){a.find(".error-customer-name").text("");var b=a.find(".search-customer").val();a.find("input[name=full_name]").val(b);a.find("#modal-register-customer").modal("show")}).on("click","#register-customer",function(){a.find(".error-customer-name").text("");var b=a.find("input[name=full_name]").val(),
c=a.find("input[name=customer_phone]").val(),h=a.find("input[name=customer_address]").val(),e=a.find("input[name=customer_note]").val();if(!b)return a.find(".error-customer-name").text("T\u00ean kh\u00e1ch h\u00e0ng kh\u00f4ng \u0111\u01b0\u1ee3c b\u1ecf tr\u1ed1ng!!!"),!1;a.model.addCustomer({full_name:b,customer_phone:c,customer_address:h,customer_note:e}).then(function(e){1==e.st&&(a.find("input[name=customer_id]").val(e.data.customer_id),a.find(".info-full-name").text(b),a.find(".info-phone").text(c),
a.find(".info-address").text(h),a.find(".input-register-customer").hide(),a.find(".info-customer-invoice").show(),a.find("#modal-register-customer").modal("hide"));bootbox.alert(e.ms)})}).on("click",".change-another-customer",function(){a.find("input[name=customer_id]").val();a.find(".info-customer-invoice").hide();a.find(".input-register-customer").show()}).on("keyup","#tags",function(){0<=$(this).val().length&&$(this).autocomplete({source:h(),select:function(b,c){a.find("input[name=customer_id]").val(c.item.customer_id);
a.find(".info-full-name").text(c.item.full_name);a.find(".info-phone").text(c.item.phone);a.find(".info-address").text(c.item.address);a.find(".input-register-customer").hide();a.find(".info-customer-invoice").show()},minLength:0});$(this).focus(function(){$(this).autocomplete("search","")})}).on("click","button[type=submit]",function(){a.find(".error").hide();var b=!0;a.find("input[name=customer_id]").val()||(a.find(".error-no-choose-customer").show(),b=!1);1>a.find("tbody tr").length?(a.find(".error-no-choose-warehouse").show(),
b=!1):$.each(a.find(".quantity"),function(){if(!$(this).val()){b=false;$(this).closest("td").find(".error-no-choose-quantity").show()}});return b}).on("show.bs.select","select.warehouse_id",function(){var a=$(this).find("option:selected");b.price=$(a).data("price");b.warehouse_id=$(a).val();b.properties_name=$(a).data("properties");b.name_show=$(a).text()});1>a.find("tbody tr").length?k():f()}},edit:{require:{scripts:["bootstrap-datepicker.js","bootstrap-select.js","bootstrap-inputmask.js"],stylesheets:["datepicker.css",
"bootstrap-select.css"]},execute:function(){var a=this,b={},j=Registry.get("WAREHOUSES"),f=function(){a.find(".select-picker").selectpicker({});a.find(".price-mask").inputmask({alias:"decimal",radixPoint:".",groupSeparator:",",autoGroup:!0,rightAlign:!0,autoUnmask:!0,removeMaskOnSubmit:!0,digits:0});a.find('[data-toggle="tooltip"]').tooltip()},i=function(){var b=0;0<a.find(".total_price").length&&$.each(a.find(".total_price"),function(){b+=+$(this).val()});a.find(".sum_total_price").text(a.model.formatNumber(b));
a.find("input[name=sum_total_price]").val(b)},m=function(){var h=[];0<a.find("select.warehouse_id").length&&a.find("select.warehouse_id").each(function(){h.push(+$(this).val())});var e='<select name="warehouse_id[]" class="form-control warehouse_id select-picker" data-live-search="true">',d="",c=0,g=!1,f=0;$.each(j.rows,function(a,b){if(-1==$.inArray(b.warehouse_id,h)){var i=b.product_name+" - S\u1ed1 L\u00f4 :"+b.production_batch+" - HSD : "+b.hsd+" - T\u1ed3n :"+b.stock;e+='<option value="'+b.warehouse_id+
'" data-price="'+b.unit_price+'" data-properties="'+b.properties_name+'">';e+=i;e+="</option>";!1==g&&(d=b.properties_name,c=+b.unit_price,f=b.warehouse_id);g=!0}});var i=a.find("table tbody tr").length+1,e=e+"</select>";a.find("tbody").append("<tr>"+('<td class="text-center stt">'+i+"</td>")+('<td class="text-center">'+e+"</td>")+('<td class="text-center">'+d+"</td>")+'<td class="text-right"><input class="form-control input price-mask quantity" name="quantity[]"><span class="error error-no-choose-quantity red" style="display: none">Nh\u1eadp SL</span></td>'+
('<td class="text-right"><input class="form-control input price-mask unit_price" name="price[]" readonly value="'+c+'"></td>')+'<td class="text-right"><input class="form-control input price-mask discount" name="discount[]"></td><td class="text-right"><input class="form-control input price-mask total_price" name="total_price[]" readonly value="0"></td><td class="text-center"><div class="hidden-sm hidden-xs btn-group"><a class="btn btn-xs btn-primary edit" data-toggle="tooltip"  style="display: none" title="S\u1eeda"><i class="ace-icon fa fa-pencil bigger-120"></i></a><a class="btn btn-xs btn-success save" data-toggle="tooltip" style="display: none" title="X\u00e1c nh\u1eadn"><i class="ace-icon fa fa-check bigger-120"></i></a><a class="btn btn-xs btn-danger remove-item" title="X\u00f3a"><i class="ace-icon fa fa-trash bigger-120"></i></a></td>');
b={};k(i,f)},k=function(h,e){$.each(a.find("select.warehouse_id"),function(a){0!=h&&a==h-1||($(this).find("option[value="+e+"]").remove(),$.isEmptyObject(b)||(a="<option value="+b.warehouse_id+" data-price="+b.price+" data-properties="+b.properties_name+">",a+=b.name_show,$(this).append(a+"</option>")))});b={};a.find(".select-picker").selectpicker("destroy");a.find(".select-picker").selectpicker();f()};a.on("keyup",".quantity, .discount",function(){var a=+$(this).closest("tr").find(".quantity").val(),
b=+$(this).closest("tr").find(".unit_price").val(),d=+$(this).closest("tr").find(".discount").val();$(this).closest("tr").find(".total_price").val(b*a-b*a*d/100);i()}).on("change","select.warehouse_id",function(){var a=+$(this).closest("tr").find(".stt").text(),b=$(this).val(),d=+$(this).closest("tr").find(".quantity").val(),c=+$(this).find("option:selected").data("price"),f=+$(this).closest("tr").find(".discount").val(),d=c*d-c*d*f/100;$(this).closest("tr").find(".unit_price").val(c);$(this).closest("tr").find(".total_price").val(d);
i();k(a,b)});1>a.find("tbody tr").length?m():f()}},expire:{require:{scripts:["bootbox/bootbox.js"],stylesheets:[]},execute:function(){var a=this;a.on("click",".remove",function(){var b=$(this).attr("rel");if(!b)return bootbox.alert("X\u1ea3y ra l\u1ed7i, vui l\u00f2ng refresh tr\u00ecnh duy\u1ec7t v\u00e0 th\u1eed l\u1ea1i!!!"),!1;bootbox.confirm("B\u1ea1n c\u00f3 mu\u1ed1n ng\u1eebng nh\u1eadn th\u00f4ng b\u00e1o s\u1eafp h\u1ebft h\u1ea1n s\u1eed d\u1ee5ng cho thu\u1ed1c n\u00e0y???",function(j){j&&
a.model.deleteExpire({id:b}).then(function(a){1==a.st?bootbox.alert(a.ms,function(){window.location=window.location.href}):bootbox.alert(a.ms)})})})}}}}});
