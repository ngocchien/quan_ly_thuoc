Controller.define("administrator/invoice",function(){return{model:{deleteInvoice:function(a){return $.ajax({type:"post",url:Registry.get("SITE_URL")+"admin/invoice/delete",data:a,dataType:"json"})},loadWarehouse:function(a){return $.ajax({type:"GET",url:Registry.get("SITE_URL")+"admin/invoice/load-warehouse",data:a,dataType:"json"})},formatNumber:function(a){x=(a+"").split(".");x1=x[0];x2=1<x.length?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2},loadCustomer:function(a){return $.ajax({type:"GET",
url:Registry.get("SITE_URL")+"admin/invoice/load-customer",data:a,dataType:"json"})},addCustomer:function(a){return $.ajax({type:"POST",url:Registry.get("SITE_URL")+"admin/customer/add-customer",data:a,dataType:"json"})}},actions:{index:{require:{scripts:["bootbox/bootbox.js"],stylesheets:[]},execute:function(){var a=this,d=function(){if(0>=a.find("input[name=data-id]:checked").length)return bootbox.alert("Vui l\u00f2ng ch\u1ecdn s\u1ea3n ph\u1ea9m mu\u1ed1n x\u00f3a!!!"),!1;bootbox.confirm("B\u1ea1n c\u00f3 ch\u1eafc ch\u1eafn mu\u1ed1n x\u00f3a c\u00e1c s\u1ea3n ph\u1ea9m n\u00e0y kh\u00f4ng???",
function(d){if(d){var e=[];a.find("input[name=data-id]:checked").each(function(){e.push($(this).val())});a.model.deleteProduct({arr_product_id:e}).then(function(a){1==a.st?bootbox.alert(a.ms,function(){window.location=window.location.href}):bootbox.alert(a.ms)})}})};a.on("click",".remove-all",function(){d()})}},create:{require:{scripts:["bootstrap-select.js","bootstrap-inputmask.js","bootbox/bootbox.js"],stylesheets:["bootstrap-select.css"]},execute:function(){var a=this,d=Registry.get("WAREHOUSES"),
g=function(){a.find(".select-picker").selectpicker({});a.find(".price-mask").inputmask({alias:"decimal",radixPoint:".",groupSeparator:",",autoGroup:!0,rightAlign:!0,autoUnmask:!0,removeMaskOnSubmit:!0,digits:0});a.find('[data-toggle="tooltip"]').tooltip()},e=function(){var c=0;0<a.find(".total_price").length&&$.each(a.find(".total_price"),function(){c+=+$(this).val()});a.find(".sum_total_price").text(a.model.formatNumber(c));a.find("input[name=sum_total_price]").val(c)},k=function(){0<a.find("tbody tr").length&&
$.each(a.find("tbody tr"),function(a,b){$(b).find(".stt").text(a+1)})},j=function(){var c=[];0<a.find("select.warehouse_id").length&&a.find("select.warehouse_id").each(function(){c.push(+$(this).val())});var b='<select name="warehouse_id[]" class="form-control warehouse_id select-picker" data-live-search="true">',h="",e=0,i=!1;$.each(d.rows,function(a,f){if(-1==$.inArray(f.warehouse_id,c)){var d=f.product_name+" - S\u1ed1 L\u00f4 :"+f.production_batch+" - HSD : "+f.hsd+" - T\u1ed3n :"+f.stock;b+=
'<option value="'+f.warehouse_id+'" data-price="'+f.unit_price+'" data-properties="'+f.properties_name+'">';b+=d;b+="</option>"}!1==i&&(h=f.properties_name,e=+f.unit_price);i=!0});var l=a.find("table tbody tr").length+1,b=b+"</select>";a.find("tbody").append("<tr>"+('<td class="text-center stt">'+l+"</td>")+('<td class="text-center">'+b+"</td>")+('<td class="text-center">'+h+"</td>")+'<td><textarea width="100%" cols="30" name="note[]"></textarea></td><td class="text-right"><input class="form-control input price-mask quantity" name="quantity[]"><span class="error error-no-choose-quantity red" style="display: none">Nh\u1eadp SL</span></td>'+
('<td class="text-right"><input class="form-control input price-mask unit_price" name="price[]" readonly value="'+e+'"></td>')+'<td class="text-right"><input class="form-control input price-mask discount" name="discount[]"></td><td class="text-right"><input class="form-control input price-mask total_price" name="total_price[]" readonly value="0"></td><td class="text-center"><div class="hidden-sm hidden-xs btn-group"><a class="btn btn-xs btn-primary edit" data-toggle="tooltip"  style="display: none" title="S\u1eeda"><i class="ace-icon fa fa-pencil bigger-120"></i></a><a class="btn btn-xs btn-success save" data-toggle="tooltip" style="display: none" title="X\u00e1c nh\u1eadn"><i class="ace-icon fa fa-check bigger-120"></i></a><a class="btn btn-xs btn-danger remove-item" data-toggle="tooltip" title="X\u00f3a"><i class="ace-icon fa fa-trash bigger-120"></i></a></td>');
g()},m=function(){var c=[],b=a.find("#tags").val();a.model.loadCustomer({search:b}).then(function(a){if(-1==a.st)return c;$.each(a.data.rows,function(a,b){var e=b.full_name,d=b.full_name;b.phone&&(d+=" - ".v.phone);b.phone&&(d+=" - ".v.address);c.push({value:e,label:d,customer_id:b.customer_id,phone:b.phone,address:b.address,note:b.note,full_name:b.full_name})})});return c};a.on("click",".add-product",j).on("click",".edit",function(){}).on("keyup",".quantity, .discount",function(){var a=+$(this).closest("tr").find(".quantity").val(),
b=+$(this).closest("tr").find(".unit_price").val(),d=+$(this).closest("tr").find(".discount").val();$(this).closest("tr").find(".total_price").val(b*a-b*a*d/100);e()}).on("click",".remove-item",function(){$(this).closest("tr").remove();k();e()}).on("change","select.warehouse_id",function(){console.log($(this).data(""))}).on("click",".add-customer",function(){a.find(".error-customer-name").text("");var c=a.find(".search-customer").val();a.find("input[name=full_name]").val(c);a.find("#modal-register-customer").modal("show")}).on("click",
"#register-customer",function(){a.find(".error-customer-name").text("");var c=a.find("input[name=full_name]").val(),b=a.find("input[name=customer_phone]").val(),d=a.find("input[name=customer_address]").val(),e=a.find("input[name=customer_note]").val();if(!c)return a.find(".error-customer-name").text("T\u00ean kh\u00e1ch h\u00e0ng kh\u00f4ng \u0111\u01b0\u1ee3c b\u1ecf tr\u1ed1ng!!!"),!1;a.model.addCustomer({full_name:c,customer_phone:b,customer_address:d,customer_note:e}).then(function(e){1==e.st&&
(a.find("input[name=customer_id]").val(e.data.customer_id),a.find(".info-full-name").text(c),a.find(".info-phone").text(b),a.find(".info-address").text(d),a.find(".input-register-customer").hide(),a.find(".info-customer-invoice").show(),a.find("#modal-register-customer").modal("hide"));bootbox.alert(e.ms)})}).on("click",".change-another-customer",function(){a.find("input[name=customer_id]").val();a.find(".info-customer-invoice").hide();a.find(".input-register-customer").show()}).on("keyup","#tags",
function(){0<=$(this).val().length&&$(this).autocomplete({source:m(),select:function(c,b){a.find("input[name=customer_id]").val(b.item.customer_id);a.find(".info-full-name").text(b.item.full_name);a.find(".info-phone").text(b.item.phone);a.find(".info-address").text(b.item.address);a.find(".input-register-customer").hide();a.find(".info-customer-invoice").show()},minLength:0});$(this).focus(function(){$(this).autocomplete("search","")})}).on("click","button[type=submit]",function(){a.find(".error").hide();
var c=!0;a.find("input[name=customer_id]").val()||(a.find(".error-no-choose-customer").show(),c=!1);1>a.find("tbody tr").length?(a.find(".error-no-choose-warehouse").show(),c=!1):$.each(a.find(".quantity"),function(){if(!$(this).val()){c=false;$(this).closest("td").find(".error-no-choose-quantity").show()}});return c});1>a.find("tbody tr").length?j():g()}},edit:{require:{scripts:["bootstrap-datepicker.js","bootstrap-select.js"],stylesheets:["datepicker.css","bootstrap-select.css"]},execute:function(){this.find(".datetimepicker").datepicker({format:"dd/mm/yyyy"});
this.find(".select-picker").selectpicker()}},expire:{require:{scripts:["bootbox/bootbox.js"],stylesheets:[]},execute:function(){var a=this;a.on("click",".remove",function(){var d=$(this).attr("rel");if(!d)return bootbox.alert("X\u1ea3y ra l\u1ed7i, vui l\u00f2ng refresh tr\u00ecnh duy\u1ec7t v\u00e0 th\u1eed l\u1ea1i!!!"),!1;bootbox.confirm("B\u1ea1n c\u00f3 mu\u1ed1n ng\u1eebng nh\u1eadn th\u00f4ng b\u00e1o s\u1eafp h\u1ebft h\u1ea1n s\u1eed d\u1ee5ng cho thu\u1ed1c n\u00e0y???",function(g){g&&a.model.deleteExpire({id:d}).then(function(a){1==
a.st?bootbox.alert(a.ms,function(){window.location=window.location.href}):bootbox.alert(a.ms)})})})}}}}});
